#!/usr/bin/env zsh

#                 _       
#         _______| |_ ____
#        |_  / _ \ __|_  /
#         / /  __/ |_ / / 
#        /___\___|\__/___|
#                         
# The most basic note taking app for the terminal.
# This script has some prerequisites:
#
#   - brew install neovim tmux fzf bat sqlite3
#   - The $ZETZ_PATH variable is set to the path of your notes.
#   - Your notes should be written in markdown (.md file extension)

pushd $ZETZ_PATH

# Perform a daily backup
file="backup/$(date "+%Y-%m-%d")-index.db"
if [[ ! -d "backup/" ]]; then
  mkdir backup
fi
if [[ ! -f  $file ]]; then
  cp index.db "$file"
fi

fzf \
  --phony \
  --no-info \
  --no-multi \
  --height=100% \
  --query="${@}" \
  --preview-window=top:65%:wrap \
  --preview 'if $(zkk -f {} {q} > /dev/null); then
               zkk -f {} {q} | bat --language md --style=plain --color always; else
               bat --language md --style=plain --color always {};
               fi' \
  --bind "change:reload:zkk {q}" \
  --bind "ctrl-o:execute-silent[ \
      tmux send-keys -t \{left\} Escape a Space && \
      tmux send-keys -t \{left\} -l \[\[{}]] && \
      tmux send-keys -t \{left\} Space && \
      tmux send-keys -t \{left\} Escape \
    ]" \
  --bind "enter:execute-silent[ \
      tmux send-keys -t \{left\} Escape :e Space && \
      tmux send-keys -t \{left\} -l {} && \
      tmux send-keys -t \{left\} Enter \
    ]" \
  --bind "ctrl-i:execute-silent[ \
      tmux send-keys -t \{left\} Escape :e Space && \
      tmux send-keys -t \{left\} -l `date +"%Y%m%d%H%M%S"`.md && \
      tmux send-keys -t \{left\} Enter \
    ]"

popd
