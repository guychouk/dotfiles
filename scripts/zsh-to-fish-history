#!/usr/bin/env python3

"""
Convert zsh extended history to fish history format.

Zsh format: : timestamp:elapsed;command
Fish format: - cmd: command
             when: timestamp
"""

import sys
import os
import re
from pathlib import Path

def convert_zsh_to_fish(zsh_history_path, fish_history_path):
    """Convert zsh extended history to fish format."""

    zsh_history = Path(zsh_history_path).expanduser()
    fish_history = Path(fish_history_path).expanduser()

    if not zsh_history.exists():
        print(f"Error: zsh history not found at {zsh_history}")
        sys.exit(1)

    # Create fish history directory if it doesn't exist
    fish_history.parent.mkdir(parents=True, exist_ok=True)

    # Read existing fish history to append (don't overwrite)
    existing_commands = set()
    if fish_history.exists():
        with open(fish_history, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read()
            # Extract existing commands to avoid duplicates
            for match in re.finditer(r'^- cmd: (.+)$', content, re.MULTILINE):
                existing_commands.add(match.group(1))

    print(f"Converting {zsh_history} to {fish_history}...")
    print(f"Existing fish history entries: {len(existing_commands)}")

    converted = 0
    skipped = 0

    with open(zsh_history, 'r', encoding='utf-8', errors='ignore') as zsh_f:
        with open(fish_history, 'a', encoding='utf-8') as fish_f:
            for line in zsh_f:
                line = line.rstrip('\n')

                # Match zsh extended history format: : timestamp:elapsed;command
                match = re.match(r'^: (\d+):\d+;(.*)$', line)
                if match:
                    timestamp = match.group(1)
                    command = match.group(2)

                    # Skip if command already exists in fish history
                    if command in existing_commands:
                        skipped += 1
                        continue

                    # Escape backslashes and quotes for YAML
                    command_escaped = command.replace('\\', '\\\\').replace('"', '\\"')

                    # Write fish history format
                    fish_f.write(f'- cmd: {command_escaped}\n')
                    fish_f.write(f'  when: {timestamp}\n')

                    existing_commands.add(command)
                    converted += 1

    print(f"✓ Converted {converted} commands")
    print(f"✓ Skipped {skipped} duplicates")
    print(f"✓ Total fish history entries: {len(existing_commands)}")

if __name__ == '__main__':
    zsh_hist = os.path.expanduser('~/.cache/zsh/history')
    fish_hist = os.path.expanduser('~/.local/share/fish/fish_history')

    convert_zsh_to_fish(zsh_hist, fish_hist)
